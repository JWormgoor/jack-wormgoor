---
const year = new Date().getFullYear();

const YOUTUBE_CHANNEL = "https://youtube.com/@jwormm?si=XgKqXQHFO98DQoAB";
const TROLLEY_VIDEO = "https://www.youtube.com/watch?v=jKCOE1u_Zvs";

// 4 dashboard cards
const metrics = [
  { key: "time", label: "Local time (UK)", value: "‚Äî", hint: "Updates automatically" },
  { key: "sun", label: "Sunrise / Sunset", value: "Loading‚Ä¶", hint: "Fetching sun times‚Ä¶" },
  { key: "weather", label: "Weather", value: "Loading‚Ä¶", hint: "Fetching weather‚Ä¶" },
  { key: "moon", label: "Moon phase", value: "‚Äî", hint: "Calculated locally" },
];

const currentProject = {
  title: "Toy Fiat 500 to Petrol",
  desc:
    "Taking a kid‚Äôs ride-on car and giving it the power of two stroke: custom chassis, full electrics, brakes, and a clean control setup. Not just a prop, a proper build.",
  status: "In progress",
  progress: 85,
  img: "/projects/fiat-rideon.jpg",
  alt: "Pink Fiat 500 ride-on toy car parked outdoors",
  cta: { label: "Build notes (soon)", href: "#" },
};

const projects = [
  {
    title: "Shopping Trolley Drift Cart",
    desc:
      "A motorised drift trolley build. Lightweight, chaotic, and surprisingly controllable once dialled in. Filmed and published.",
    tag: "Build + Video",
    status: "Completed",
    img: "/projects/trolley-drift-cart.jpg",
    alt: "A modified shopping trolley turned into a drift cart in a car park",
    links: [{ label: "Watch on YouTube", href: TROLLEY_VIDEO }],
    bullets: [
      "Problem: Make a cheap platform that can actually drift.",
      "Build: Reinforced frame + drive + control tweaks.",
      "Result: Working drift cart + video published.",
    ],
  },
  {
    title: "FM Emergency Broadcaster (‚âà7-mile range)",
    desc:
      "Built using a car FM transmitter and upgraded into a longer range local broadcast experiment for emergency style messaging. Able to broadcast speech, tones, and music.",
    tag: "Radio / RF",
    status: "Completed",
    img: "/projects/fm-emergency-broadcaster.jpg",
    alt: "An outdoor antenna mounted near a window at night",
    links: [{ label: "Write-up (soon)", href: "#" }],
    bullets: [
      "Problem: Low cost broadcast for local alerts and experiments.",
      "Build: Transmitter + antenna + placement + tuning.",
      "Result: Near ~7 miles effective range in testing.",
    ],
  },
  {
    title: "Flame Thrower Build",
    desc:
      "A finished build project. One of those ‚Äòbecause I can‚Äô experiments, documented with care and restraint.",
    tag: "Build",
    status: "Completed",
    img: "/projects/flame-thrower.jpg",
    alt: "A flame thrower project photo",
    links: [{ label: "Write-up (soon)", href: "#" }],
    bullets: [
      "Problem: Build a controlled flame tool for a project experiment.",
      "Build: Hardware + fuel delivery + ignition system.",
      "Result: Working unit + test footage captured.",
    ],
  },
];

const capabilities = [
  { title: "Rapid prototyping", desc: "From idea to working thing. Fast iteration, practical choices.", icon: "‚öôÔ∏è" },
  { title: "Workshop builds", desc: "Mechanical mods, fabrication, making parts do what they need to do.", icon: "üõ†Ô∏è" },
  { title: "Electronics & wiring", desc: "Power, switching, controls, keeping it reliable.", icon: "üîå" },
  { title: "Radio experiments", desc: "FM and RF experiments and communication tests.", icon: "üìª" },
  { title: "Web & automation", desc: "Astro, APIs, Cloudflare. Clean, fast, and maintainable.", icon: "üåê" },
  { title: "Video documentation", desc: "I build, I film, and I explain the story clearly.", icon: "üé•" },
];

const highlights = [
  { k: "Problem solving", v: "Practical & methodical", d: "Break problems down, test ideas quickly, iterate until it works." },
  { k: "Build mindset", v: "Real world focused", d: "Designing things that survive use, not just look good on paper." },
  { k: "Communication", v: "Clear & documented", d: "Explaining builds, decisions, and results clearly on video and in writing." },
  { k: "Reliability", v: "Consistent delivery", d: "Comfortable working independently or in teams, meeting deadlines and standards." },
];
---

<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jack Wormgoor</title>
    <meta name="description" content="Jack Wormgoor. Builder, experimenter, problem solver." />

    <style>
      :root {
        --bg: #f4f1ea;
        --ink: #1f1a14;
        --muted: #6b6258;
        --card: #fbf9f4;
        --line: #e4ded4;
        --accent: #2a2119;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
        --radius: 18px;
      }

      html[data-theme="dark"] {
        --bg: #0f1115;
        --ink: #ede7dc;
        --muted: #b7ad9f;
        --card: #151821;
        --line: #2a2f3a;
        --accent: #ede7dc;
        --shadow: 0 12px 34px rgba(0, 0, 0, 0.35);
      }

      html[data-theme="golden"] {
        --bg: #1a140f;
        --ink: #fff1dd;
        --muted: #e3c7a3;
        --card: #241b14;
        --line: #3a2c21;
        --accent: #ffcc8a;
        --shadow: 0 12px 34px rgba(0, 0, 0, 0.45);
      }

      * { box-sizing: border-box; }
      html, body { margin: 0; padding: 0; }

      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: var(--ink);
        line-height: 1.5;
        transition: background-color 900ms ease, color 900ms ease;
      }

      a { color: inherit; text-decoration: none; }
      a:hover { opacity: 0.94; }

      .wrap { max-width: 1080px; margin: 0 auto; padding: 28px 18px; }

      .header {
        display: flex; align-items: center; justify-content: space-between; gap: 18px;
        padding-top: 18px; padding-bottom: 10px;
      }

      .brand { display: flex; align-items: center; gap: 12px; }

      .mark {
        width: 40px; height: 40px; border-radius: 12px;
        display: grid; place-items: center;
        background: var(--accent); color: var(--bg);
        font-weight: 800; letter-spacing: 0.04em;
        box-shadow: var(--shadow);
        transition: background-color 900ms ease, color 900ms ease, border-color 900ms ease, box-shadow 900ms ease;
      }

      .nav { display: flex; gap: 14px; flex-wrap: wrap; }
      .nav a { padding: 8px 10px; border-radius: 12px; transition: background-color 600ms ease; }
      .nav a:hover { background: rgba(127, 127, 127, 0.16); }

      .hero { padding: 28px 0 12px; }

      .heroTop {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 14px;
        align-items: stretch;
      }

      .kicker {
        margin: 0 0 10px; color: var(--muted);
        letter-spacing: 0.12em; text-transform: uppercase; font-size: 0.78rem;
      }

      h1 { margin: 0 0 10px; font-size: clamp(2rem, 4vw, 3.1rem); line-height: 1.06; }

      .lede { margin: 0; max-width: 70ch; color: var(--muted); font-size: 1.06rem; }

      .cta { display: flex; gap: 12px; margin: 18px 0 0; flex-wrap: wrap; }

      .btn {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 10px 14px; border-radius: 14px;
        background: var(--accent); color: var(--bg);
        border: 1px solid rgba(0, 0, 0, 0.06);
        box-shadow: var(--shadow);
        font-weight: 650;
        transition: transform 220ms ease, background-color 900ms ease, color 900ms ease, border-color 900ms ease, box-shadow 900ms ease;
      }
      .btn:hover { transform: translateY(-1px); }

      .btn.ghost {
        background: transparent; color: var(--ink);
        border: 1px solid var(--line);
        box-shadow: none;
      }

      .slot {
        background: linear-gradient(135deg, rgba(127,127,127,0.18), rgba(127,127,127,0.06));
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
        display: grid;
        gap: 10px;
        align-content: start;
        transition: background-color 900ms ease, border-color 900ms ease, box-shadow 900ms ease;
      }
      .slot .slotTop { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
      .slot .tag {
        font-size: 0.75rem;
        border: 1px solid var(--line);
        color: var(--muted);
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(255,255,255,0.25);
        white-space: nowrap;
      }
      .slot .ph {
        width: 100%;
        aspect-ratio: 16 / 10;
        border-radius: 14px;
        border: 1px dashed rgba(127,127,127,0.35);
        display: grid;
        place-items: center;
        color: var(--muted);
        font-size: 0.92rem;
        padding: 10px;
      }
      .slot .ph small { display: block; opacity: 0.9; }

      .metrics {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        margin-top: 14px;
      }

      .metric, .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        transition: transform 220ms ease, background-color 900ms ease, color 900ms ease, border-color 900ms ease, box-shadow 900ms ease;
      }

      .metric { padding: 14px 14px 12px; }
      .metric .label { font-size: 0.8rem; color: var(--muted); }
      .metric .value { font-size: 1.25rem; font-weight: 800; margin-top: 4px; }
      .metric .hint { font-size: 0.82rem; color: var(--muted); margin-top: 6px; }

      .card:hover, .metric:hover { transform: translateY(-2px); }

      .themeLine { margin-top: 10px; color: var(--muted); font-size: 0.92rem; }
      .themeLine strong { color: var(--ink); }

      .section { margin-top: 26px; }
      .sectionhead {
        display: flex; align-items: flex-end; justify-content: space-between;
        gap: 16px; flex-wrap: wrap;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--line);
      }
      .sectionhead h2 { margin: 0; font-size: 1.3rem; }
      .muted { color: var(--muted); }

      .valueStrip {
        margin-top: 18px;
        display: grid;
        grid-template-columns: 1.15fr 0.85fr;
        gap: 14px;
        align-items: stretch;
      }
      .valueStrip .card { padding: 18px; }

      .proof {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 18px;
      }

      .proofHeaderRow {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
      }

      .proofHeaderRow h2 { margin: 0; }
      .proofSub { margin: 0; color: var(--muted); font-size: 0.95rem; text-align: right; }

      .proofRow {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: rgba(255,255,255,0.25);
      }
      .proofRow span { color: var(--muted); }
      .proofRow strong { font-weight: 750; text-align: right; }

      .highlights {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
      }
      .mini { padding: 14px; }
      .mini .k { color: var(--muted); font-size: 0.8rem; }
      .mini .v { font-weight: 850; font-size: 1.15rem; margin-top: 4px; }
      .mini .d { color: var(--muted); font-size: 0.82rem; margin-top: 6px; }

      .caps {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 14px;
      }
      .cap { padding: 16px; display: grid; gap: 8px; align-content: start; }
      .capTop { display: flex; gap: 10px; align-items: center; }
      .capIcon {
        width: 38px; height: 38px;
        border-radius: 14px;
        display: grid; place-items: center;
        border: 1px solid var(--line);
        background: rgba(255,255,255,0.25);
        font-size: 1.1rem;
      }
      .cap h3 { margin: 0; font-size: 1.02rem; }
      .cap p { margin: 0; color: var(--muted); }

      .featured {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 14px;
        margin-top: 12px;
        align-items: stretch;
      }

      .progressWrap { margin-top: 12px; }
      .progressTop { display:flex; justify-content: space-between; gap: 12px; font-size: 0.82rem; color: var(--muted); margin-bottom: 6px; }
      .bar {
        height: 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        overflow: hidden;
        background: rgba(127,127,127,0.10);
      }
      .fill {
        height: 100%;
        width: 0%;
        background: var(--accent);
        transition: width 1200ms cubic-bezier(.2,.8,.2,1), background-color 900ms ease;
      }

      .cards {
        display: grid; gap: 14px; margin-top: 12px;
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .project { padding: 0; overflow: hidden; }

      .media {
        position: relative;
        width: 100%;
        aspect-ratio: 1 / 1;
        background: linear-gradient(135deg, rgba(127,127,127,0.18), rgba(127,127,127,0.06));
        border-bottom: 1px solid var(--line);
        overflow: hidden;
      }
      .thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        display: block;
      }
      .projectBody { padding: 16px; }
      .badgeRow { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        color: var(--muted);
        font-size: 0.78rem;
        background: rgba(255, 255, 255, 0.28);
        white-space: nowrap;
      }
      .pill.strong { color: var(--ink); }

      .bullets { margin: 10px 0 0; padding-left: 16px; color: var(--muted); }
      .bullets li { margin: 6px 0; }

      .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
      .actionLink {
        display: inline-flex;
        align-items: center;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid var(--line);
        color: var(--ink);
        background: transparent;
        font-size: 0.9rem;
        transition: transform 180ms ease, background-color 250ms ease;
      }
      .actionLink:hover { background: rgba(127,127,127,0.12); transform: translateY(-1px); }

      .footer { margin: 30px 0 10px; }

      .reveal { opacity: 0; transform: translateY(8px); transition: opacity 700ms ease, transform 700ms ease; }
      .reveal.is-in { opacity: 1; transform: translateY(0); }

      @media (max-width: 980px) {
        .metrics { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .highlights { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .valueStrip { grid-template-columns: 1fr; }
        .heroTop { grid-template-columns: 1fr; }
        .proofSub { text-align: left; }
      }

      @media (max-width: 900px) {
        .featured { grid-template-columns: 1fr; }
        .caps { grid-template-columns: 1fr; }
      }

      @media (max-width: 840px) {
        .cards { grid-template-columns: 1fr; }
      }

      @media (prefers-reduced-motion: reduce) {
        .reveal { opacity: 1; transform: none; transition: none; }
        .fill { transition: none; }
        .btn, .card, .metric, .actionLink { transition: none; }
      }
    </style>
  </head>

  <body>
    <header class="wrap header reveal">
      <a class="brand" href="/">
        <span class="mark" aria-hidden="true">JW</span>
        <span style="font-weight: 700">Jack Wormgoor</span>
      </a>

      <nav class="nav" aria-label="Primary">
        <a href="#projects">Projects</a>
        <a href="#capabilities">Capabilities</a>
        <a href="#contact">Contact</a>
      </nav>
    </header>

    <main class="wrap">
      <section class="hero reveal">
        <div class="heroTop">
          <div class="card" style="padding:18px;">
            <p class="kicker">jackwormgoor.com</p>
            <h1>Builder, experimenter, problem solver.</h1>
            <p class="lede">
              I build real world prototypes and the systems around them - workshop builds, radio experiments,
              and web tools that pull live data.
            </p>

            <div class="cta">
              <a class="btn" href="#projects">See projects</a>
              <a class="btn ghost" href={YOUTUBE_CHANNEL} target="_blank" rel="noreferrer">YouTube</a>
            </div>
          </div>

          <aside class="slot">
            <div class="slotTop">
              <strong>Featured media</strong>
              <span class="tag">Add an image later</span>
            </div>
            <div class="ph">
              Add a strong hero image here
              <small>1600√ó1000 (or any 16:10-ish)</small>
            </div>
            <p class="muted" style="margin:0;">
              finna put smt here soon when i find an image, don't let me forget.
            </p>
          </aside>
        </div>

        <div class="metrics" aria-label="Live dashboard">
          {metrics.map((m) => (
            <div class="metric reveal" data-key={m.key}>
              <div class="label">{m.label}</div>
              <div class="value">{m.value}</div>
              <div class="hint">{m.hint}</div>
            </div>
          ))}
        </div>

        <div class="themeLine reveal">
          Theme: <strong id="themeLabel">Auto</strong> <span id="themeHint">‚Äî</span>
        </div>

        <div class="valueStrip">
          <article class="card reveal">
            <h2 style="margin:0 0 8px;">What I do</h2>
            <p class="muted" style="margin:0 0 10px;">
              I design and build real world systems. Anything from mechanical workshop projects through to radio experiments,
              and web tooling and much more.
            </p>
            <p class="muted" style="margin:0;">
              I like projects that have practical application to the real world, and all the phases of planning and building that are included throughout. 
             </p>
            <p class="muted" style="margin:0;">
              I work best when the solution has to be practical, explainable, and reliable, and then documented properly.
            </p>
          </article>

          <aside class="card proof reveal">
            <div class="proofHeaderRow">
              <h2>Skills & Abilities</h2>
            </div>

            <div class="proofRow">
              <span>Strengths</span>
              <strong>Problem solving, planning, attention to detail.</strong>
            </div>

            <div class="proofRow">
              <span>Work style</span>
              <strong>Logical, hands on, reliable under pressure.</strong>
            </div>

            <div class="proofRow">
              <span>Technical</span>
              <strong>Mechanical builds, electronics, radio, web.</strong>
            </div>
          </aside>
        </div>
      </section>

      <section class="section">
        <div class="sectionhead reveal">
          <h2>Highlights</h2>
          <p class="muted">A brief dive into how I work.</p>
        </div>

        <div class="highlights">
          {highlights.map((h) => (
            <div class="card mini reveal">
              <div class="k">{h.k}</div>
              <div class="v">{h.v}</div>
              <div class="d">{h.d}</div>
            </div>
          ))}
        </div>
      </section>

      <section id="capabilities" class="section">
        <div class="sectionhead reveal">
          <h2>Capabilities</h2>
          <p class="muted">What I‚Äôm good at and what I actually enjoy doing.</p>
        </div>

        <div class="caps">
          {capabilities.map((c) => (
            <div class="card cap reveal">
              <div class="capTop">
                <div class="capIcon" aria-hidden="true">{c.icon}</div>
                <h3>{c.title}</h3>
              </div>
              <p>{c.desc}</p>
            </div>
          ))}
        </div>
      </section>

      <section class="section" aria-label="Current project">
        <div class="sectionhead reveal">
          <h2>Current project</h2>
          <p class="muted">What I‚Äôm actively working on right now.</p>
        </div>

        <div class="featured">
          <article class="card reveal" style="padding:18px;">
            <h3 style="margin-top: 0">{currentProject.title}</h3>
            <p class="muted" style="margin-top: 6px">{currentProject.desc}</p>

            <div class="badgeRow">
              <span class="pill strong">Build</span>
              <span class="pill">{currentProject.status}</span>
            </div>

            <div class="progressWrap">
              <div class="progressTop">
                <span>Progress</span>
                <span>{currentProject.progress}%</span>
              </div>
              <div class="bar" aria-label={`Progress ${currentProject.progress}%`}>
                <div class="fill progress-fill" data-progress={currentProject.progress}></div>
              </div>
            </div>

            <div class="actions">
              <a class="actionLink" href={currentProject.cta.href}>{currentProject.cta.label}</a>
            </div>
          </article>

          <article class="card project reveal" style="padding:0;">
            <div class="media" style="aspect-ratio: 16 / 10;">
              <img class="thumb" src={currentProject.img} alt={currentProject.alt} loading="lazy" onerror="this.style.display='none';" />
            </div>
          </article>
        </div>
      </section>

      <section id="projects" class="section">
        <div class="sectionhead reveal">
          <h2>Selected projects</h2>
          <p class="muted">Builds and experiments. More write ups coming.</p>
        </div>

        <div class="cards">
          {projects.map((p) => (
            <article class="card project reveal">
              <div class="media">
                <img class="thumb" src={p.img} alt={p.alt} loading="lazy" onerror="this.style.display='none';" />
              </div>

              <div class="projectBody">
                <h3 style="margin: 0">{p.title}</h3>
                <p class="muted" style="margin: 6px 0 0">{p.desc}</p>

                <div class="badgeRow">
                  <span class="pill strong">{p.tag}</span>
                  <span class="pill">{p.status}</span>
                </div>

                {p.bullets?.length ? (
                  <ul class="bullets">
                    {p.bullets.map((b) => <li>{b}</li>)}
                  </ul>
                ) : null}

                {p.links?.length ? (
                  <div class="actions">
                    {p.links.map((l) => (
                      <a
                        class="actionLink"
                        href={l.href}
                        target={l.href.startsWith("http") ? "_blank" : undefined}
                        rel={l.href.startsWith("http") ? "noreferrer" : undefined}
                      >
                        {l.label}
                      </a>
                    ))}
                  </div>
                ) : null}
              </div>
            </article>
          ))}
        </div>
      </section>

      <section id="contact" class="section">
        <div class="sectionhead reveal">
          <h2>Contact</h2>
          <p class="muted">If you‚Äôve got a project, collaboration, or anything mildly out of the ordinary, I‚Äôm interested.</p>
        </div>

        <div class="cards" style="grid-template-columns: 1fr;">
          <div class="card reveal" style="padding:18px;">
            <p class="muted" style="margin: 8px 0;">
              <strong>Email:</strong> <a href="mailto:jackwormgoor@gmail.com">jackwormgoor@gmail.com</a>
            </p>
            <p class="muted" style="margin: 8px 0;"><strong>GitHub:</strong> github.com/JWormgoor</p>
            <p class="muted" style="margin: 8px 0;">
              <strong>YouTube:</strong>
              <a href={YOUTUBE_CHANNEL} target="_blank" rel="noreferrer">{YOUTUBE_CHANNEL}</a>
            </p>
          </div>
        </div>
      </section>

      <footer class="footer reveal">
        <p class="muted">¬© {year} Jack Wormgoor. Built by Jack Wormgoor.</p>
      </footer>
    </main>

    <script>
      function pad2(n) { return String(n).padStart(2, "0"); }
      function fmtTime(d) { return pad2(d.getHours()) + ":" + pad2(d.getMinutes()); }
      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      function getCard(key) {
        return document.querySelector('.metric[data-key="' + key + '"]');
      }

      function setCard(key, obj) {
        var card = getCard(key);
        if (!card) return;
        if (obj.value !== undefined) card.querySelector(".value").textContent = obj.value;
        if (obj.hint !== undefined) card.querySelector(".hint").textContent = obj.hint;
      }

      function setThemeText(label, hint) {
        var el = document.getElementById("themeLabel");
        var h = document.getElementById("themeHint");
        if (el) el.textContent = label;
        if (h) h.textContent = hint ? "‚Ä¢ " + hint : "‚Äî";
      }

      (function () {
        var els = document.querySelectorAll(".reveal");
        var reduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

        if (reduced || !("IntersectionObserver" in window)) {
          els.forEach(function (el) { el.classList.add("is-in"); });
          return;
        }

        var io = new IntersectionObserver(function (entries) {
          entries.forEach(function (e) {
            if (e.isIntersecting) {
              e.target.classList.add("is-in");
              io.unobserve(e.target);
            }
          });
        }, { threshold: 0.12 });

        els.forEach(function (el) { io.observe(el); });
      })();

      (function () {
        var fill = document.querySelector(".progress-fill");
        if (!fill) return;

        var reduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        var target = clamp(parseInt(fill.dataset.progress || "0", 10), 0, 100);

        function run() {
          setTimeout(function () {
            fill.style.width = target + "%";
          }, 120);
        }

        if (reduced || !("IntersectionObserver" in window)) return run();

        var io = new IntersectionObserver(function (entries) {
          entries.forEach(function (e) {
            if (e.isIntersecting) {
              run();
              io.disconnect();
            }
          });
        }, { threshold: 0.35 });

        io.observe(fill);
      })();

      (function () {
        function tick() {
          var d = new Date();
          setCard("time", {
            value: d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
            hint: d.toLocaleDateString([], { weekday: "short", day: "2-digit", month: "short" })
          });
        }
        tick();
        setInterval(tick, 15000);
      })();

      function moonPhaseFraction(date) {
        if (!date) date = new Date();
        var synodicMonth = 29.530588853;
        var knownNewMoon = Date.UTC(2000, 0, 6, 18, 14, 0);
        var daysSince = (date.getTime() - knownNewMoon) / (1000 * 60 * 60 * 24);
        var phase = (daysSince % synodicMonth) / synodicMonth;
        return (phase + 1) % 1;
      }

      function moonEmojiAndName(frac) {
        var idx = Math.floor(((frac + 1 / 16) % 1) * 8);
        var phases = [
          { e: "üåë", n: "New" },
          { e: "üåí", n: "Waxing crescent" },
          { e: "üåì", n: "First quarter" },
          { e: "üåî", n: "Waxing gibbous" },
          { e: "üåï", n: "Full" },
          { e: "üåñ", n: "Waning gibbous" },
          { e: "üåó", n: "Last quarter" },
          { e: "üåò", n: "Waning crescent" }
        ];
        return phases[idx];
      }

      function setMoon() {
        var frac = moonPhaseFraction(new Date());
        var p = moonEmojiAndName(frac);
        var pct = Math.round(frac * 100);
        setCard("moon", { value: p.e + " " + p.n, hint: "Phase: " + pct + "% through cycle" });
      }
      setMoon();
      setInterval(setMoon, 6 * 60 * 60 * 1000);

      async function fetchSunTimes(lat, lng) {
        var url = "https://api.sunrise-sunset.org/json?lat=" + lat + "&lng=" + lng + "&formatted=0";
        var res = await fetch(url);
        if (!res.ok) throw new Error("Sun API failed");
        var data = await res.json();
        if (data.status !== "OK") throw new Error("Sun API not OK");
        return { sunrise: new Date(data.results.sunrise), sunset: new Date(data.results.sunset) };
      }

      async function fetchWeatherAndRain(lat, lng) {
        var url =
          "https://api.open-meteo.com/v1/forecast?latitude=" + lat +
          "&longitude=" + lng +
          "&current_weather=true&hourly=precipitation_probability,precipitation&timezone=auto";

        var res = await fetch(url);
        if (!res.ok) throw new Error("Weather API failed");
        var data = await res.json();

        var cw = data.current_weather;
        var times = (data.hourly && data.hourly.time) ? data.hourly.time : [];
        var pop = (data.hourly && data.hourly.precipitation_probability) ? data.hourly.precipitation_probability : [];
        var prc = (data.hourly && data.hourly.precipitation) ? data.hourly.precipitation : [];

        if (!cw) throw new Error("No current weather");

        var now = new Date();
        var bestIdx = 0;
        var bestDiff = Infinity;

        for (var i = 0; i < times.length; i++) {
          var t = new Date(times[i]);
          var diff = Math.abs(t.getTime() - now.getTime());
          if (diff < bestDiff) { bestDiff = diff; bestIdx = i; }
        }

        var nextIdx = Math.min(bestIdx + 1, pop.length - 1);
        var rainChance = (pop[nextIdx] != null) ? pop[nextIdx] : (pop[bestIdx] != null ? pop[bestIdx] : null);
        var rainMm = (prc[nextIdx] != null) ? prc[nextIdx] : (prc[bestIdx] != null ? prc[bestIdx] : null);

        return {
          temp: cw.temperature,
          wind: cw.windspeed,
          rainChance: rainChance,
          rainMm: rainMm
        };
      }

      function minutesToHM(mins) {
        var h = Math.floor(mins / 60);
        var m = Math.round(mins % 60);
        return h + "h " + pad2(m) + "m";
      }

      function applyThemeFromSun(sunrise, sunset) {
        var now = new Date();
        var goldenMinutes = 30;
        var goldenMs = goldenMinutes * 60 * 1000;

        var goldenAfterSunriseStart = sunrise;
        var goldenAfterSunriseEnd = new Date(sunrise.getTime() + goldenMs);

        var goldenBeforeSunsetStart = new Date(sunset.getTime() - goldenMs);
        var goldenBeforeSunsetEnd = sunset;

        var isGolden =
          (now >= goldenAfterSunriseStart && now <= goldenAfterSunriseEnd) ||
          (now >= goldenBeforeSunsetStart && now <= goldenBeforeSunsetEnd);

        var isDay = now >= sunrise && now < sunset;

        var theme = "dark";
        if (isGolden) theme = "golden";
        else if (isDay) theme = "light";

        document.documentElement.dataset.theme = theme;

        var label = (theme === "light") ? "Day" : (theme === "golden") ? "Golden" : "Night";
        setThemeText(label, "Golden window ¬±" + goldenMinutes + " mins");
      }

      function scheduleNextSwitch(sunrise, sunset) {
        var now = new Date();
        var goldenMinutes = 30;
        var goldenMs = goldenMinutes * 60 * 1000;

        var boundaries = [
          sunrise,
          new Date(sunrise.getTime() + goldenMs),
          new Date(sunset.getTime() - goldenMs),
          sunset
        ].filter(function (t) { return t.getTime() > now.getTime(); });

        if (boundaries.length === 0) return;

        boundaries.sort(function (a, b) { return a.getTime() - b.getTime(); });
        var next = boundaries[0];

        var ms = next.getTime() - now.getTime();
        setTimeout(function () {
          applyThemeFromSun(sunrise, sunset);
          scheduleNextSwitch(sunrise, sunset);
        }, Math.max(5000, ms + 5000));
      }

      async function initEverything() {
        var fallback = { lat: 51.0688, lng: -1.7945 };

        var position = await new Promise(function (resolve) {
          if (!navigator.geolocation) return resolve(null);
          navigator.geolocation.getCurrentPosition(
            function (pos) { resolve(pos); },
            function () { resolve(null); },
            { enableHighAccuracy: false, timeout: 4000, maximumAge: 3600000 }
          );
        });

        var lat = position && position.coords && position.coords.latitude != null ? position.coords.latitude : fallback.lat;
        var lng = position && position.coords && position.coords.longitude != null ? position.coords.longitude : fallback.lng;

        try {
          setCard("sun", { value: "Loading‚Ä¶", hint: "Fetching sunrise/sunset‚Ä¶" });

          var st = await fetchSunTimes(lat, lng);
          var sunrise = st.sunrise;
          var sunset = st.sunset;

          var daylightMins = (sunset.getTime() - sunrise.getTime()) / (60 * 1000);
          var daylight = minutesToHM(daylightMins);

          setCard("sun", {
            value: fmtTime(sunrise) + " ‚Üë  " + fmtTime(sunset) + " ‚Üì",
            hint: "Daylight: " + daylight
          });

          applyThemeFromSun(sunrise, sunset);
          scheduleNextSwitch(sunrise, sunset);
        } catch (e) {
          setCard("sun", { value: "Unavailable", hint: "Couldn‚Äôt fetch sun times" });
          setThemeText("Auto", "‚Äî");
        }

        try {
          setCard("weather", { value: "Loading‚Ä¶", hint: "Fetching weather‚Ä¶" });

          var w = await fetchWeatherAndRain(lat, lng);

          var tempText = Math.round(w.temp) + "¬∞C";
          var windText = "Wind " + Math.round(w.wind) + " km/h";

          var chance = w.rainChance != null ? w.rainChance : null;
          var mm = w.rainMm != null ? w.rainMm : null;

          var rainText = "Rain: ‚Äî";
          if (chance !== null) {
            var mmText = (mm !== null && mm > 0) ? " (~" + mm.toFixed(1) + "mm)" : "";
            rainText = "Rain: " + Math.round(chance) + "%" + mmText;
          }

          setCard("weather", {
            value: tempText,
            hint: rainText + " ‚Ä¢ " + windText
          });
        } catch (e) {
          setCard("weather", { value: "Unavailable", hint: "Weather fetch failed" });
        }

        setTimeout(initEverything, 20 * 60 * 1000);
      }

      initEverything();
    </script>
  </body>
</html>
